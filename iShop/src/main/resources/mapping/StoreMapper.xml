<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bizvane.ishop.dao.StoreMapper">

    <resultMap type="com.bizvane.ishop.entity.Store" id="Store">
        <id column="id" property="id"/>
        <result column="logo" property="logo" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="store_id" property="store_id" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="store_code" property="store_code"/>
        <result column="store_name" property="store_name"/>
        <result column="brand_code" property="brand_code" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="area_code" property="area_code" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="area_name" property="area_name" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="brand_name" property="brand_name" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="flg_tob" property="flg_tob" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="corp_code" property="corp_code"/>
        <result column="province" property="province" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="city" property="city" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="area" property="area" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="street" property="street" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="lng" property="lng" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="lat" property="lat" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="distance" property="distance" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="modified_date" property="modified_date"
                typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="modifier" property="modifier" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="offline_area" property="offline_area" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="dealer" property="dealer" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="store_type" property="store_type" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="isopen" property="isopen" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="open_date" property="open_date" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="close_date" property="close_date" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="open_person" property="open_person" typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="open_date_count" property="open_date_count"
                typeHandler="com.bizvane.ishop.utils.EmptyStringIfNull"/>
        <result column="isactive" property="isactive"/>
        <association property="corp" javaType="com.bizvane.ishop.entity.Corp">
            <result column="corp_name" property="corp_name"/>
        </association>
    </resultMap>

    <select id="selectByStoreId" resultMap="Store">
        SELECT
        def_store.id,
        store_id,
        store_code,
        store_name,
        brand_code,
        flg_tob,
        def_store.province,
        def_store.city,
        def_store.area,
        def_store.street,
        def_store.lng,
        def_store.lat,
        def_store.area_code,
        def_store.corp_code,
        def_store.modified_date,
        def_store.modifier,
        def_store.created_date,
        def_store.creater,
        def_store.isactive,
         def_store.offline_area,
         def_store.dealer,
         def_store.store_type,
         def_store.isopen,
         def_store.open_date,
         def_store.close_date,
         def_store.open_date_count,
         def_store.open_person,
        def_corp.corp_name,
        def_store.logo
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.id=#{id}
    </select>

    <select id="selectByCode" resultType="com.bizvane.ishop.entity.Store">
        SELECT *
        FROM def_store
        WHERE corp_code = #{corp_code}
        AND store_code = #{store_code}
        <if test="isactive != null and isactive !=''">
            AND isactive = #{isactive}
        </if>
    </select>

    <!--判断店铺id是否重复-->
    <select id="selStoreByStroeId" resultType="com.bizvane.ishop.entity.Store">
        SELECT * FROM def_store
        where corp_code = #{corp_code}
        AND store_id = #{store_id}
        <if test="isactive != null and isactive !=''">
            AND isactive = #{isactive}
        </if>
    </select>

    <select id="selectAllStore" resultMap="Store">
        SELECT
        def_store.id,
        store_id,
        store_code,
        store_name,
        flg_tob,
        province,
        city,
        area,
        street,
        def_store.area_code,
        def_store.brand_code,
        def_store.corp_code,
        def_store.modified_date,
        def_store.modifier,
        def_store.isactive,
        def_store.offline_area,
        def_store.dealer,
        def_store.store_type,
        def_store.isopen,
        def_store.open_date,
        def_store.close_date,
        def_store.open_date_count,
        def_store.open_person,
        def_corp.corp_name,
        def_store.logo
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        <if test="corp_code != null and corp_code !=''">
            AND def_store.corp_code = #{corp_code}
        </if>
        <if test="manager_corp_arr!=null">
            AND
            <foreach collection="manager_corp_arr" index="index" item="item" open="(" separator="or" close=")">
                def_store.corp_code =#{item}
            </foreach>
        </if>
        <if test="find_type=='user'.toString()">
            AND def_store.isactive='Y'
            AND (def_store.isopen='Y' OR def_store.close_date is NOT NULL )

        </if>
        <if test="search_value != null and search_value !=''">
            AND
            (store_code LIKE concat('%',#{search_value},'%')
            OR store_id LIKE concat('%',#{search_value},'%')
            OR store_name LIKE concat('%',#{search_value},'%')
            OR def_corp.corp_name LIKE concat('%',#{search_value},'%')
            )
        </if>
        <if test="offline_area != null and offline_area !=''">
            AND def_store.offline_area = #{offline_area}
        </if>
        <if test="store_type != null and store_type !=''">
            AND def_store.store_type = #{store_type}
        </if>
        <if test="dealer != null and dealer !=''">
            AND def_store.dealer = #{dealer}
        </if>
        <if test="search_area_code != null and search_area_code !=''">
            AND def_store.area_code LIKE concat('%',#{search_area_code},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <select id="selectByCorp" resultMap="Store">
        select def_store.*,def_corp.corp_name
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.corp_code = #{corp_code}
        AND def_store.isactive = 'Y'
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <select id="selectByAreaBrand" resultMap="Store">
        select
        def_store.id,
        store_id,
        store_code,
        store_name,
        province,
        city,
        area,
        street,
        def_store.brand_code,
        flg_tob,
        def_store.area_code,
        def_store.corp_code,
        def_store.modified_date,
        def_store.modifier,
        def_store.isactive,
        def_store.offline_area,
        def_store.dealer,
        def_store.store_type,
        def_store.isopen,
        def_store.open_date,
        def_store.close_date,
        def_store.open_date_count,
        def_store.open_person,
        def_store.logo,
        def_corp.corp_name
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.corp_code = #{corp_code}
        <!--<if test="corp_code =='C10125'.toString()">-->
            <!--AND store_name NOT LIKE '%停用%'-->
        <!--</if>-->
        <if test="find_type=='user'.toString()">
            AND (def_store.isopen='Y' OR def_store.close_date is NOT NULL )
            AND def_store.isactive='Y'
        </if>
        <if test="area_code != null">
            AND (
            <foreach item="item" index="index" collection="area_code" open="(" separator="or" close=")">
                def_store.area_code LIKE concat('%',#{item},'%')
            </foreach>
            <if test="store_codes != null and store_codes !=''">
                OR def_store.store_code IN
                <foreach collection="store_codes" index="index" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            )
        </if>
        <if test="brand_code != null">
            AND
            <foreach item="item" index="index" collection="brand_code" open="(" separator="or" close=")">
                def_store.brand_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="search_area_code != null and search_area_code !=''">
            AND def_store.area_code LIKE concat('%',#{search_area_code},'%')
        </if>
        <if test="search_value != null and search_value !=''">
            AND
            (store_code like concat('%',#{search_value},'%')
            OR store_id LIKE concat('%',#{search_value},'%')
            OR store_name like concat('%',#{search_value},'%')
            OR def_corp.corp_name like concat('%',#{search_value},'%')
            )
        </if>
        <if test="offline_area != null and offline_area !=''">
            AND def_store.offline_area LIKE concat('%',#{offline_area},'%')
        </if>
        <if test="dealer != null and dealer !=''">
            AND def_store.dealer LIKE concat('%',#{dealer},'%')
        </if>
        <if test="store_type != null and store_type !=''">
            AND def_store.store_type LIKE concat('%',#{store_type},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <!--下拉框，根据区域拉店铺(区经，企业管理员)-->
    <select id="selStoreByAreaBrand" resultMap="Store">
        select
        def_store.id,
        store_id,
        store_code,
        store_name,
        def_store.area_code,
        def_store.corp_code,
        def_store.logo,
        def_corp.corp_name
        from def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        <if test="corp_code != null and corp_code !=''">
            AND def_store.corp_code = #{corp_code}
        </if>
        <if test="manager_corp_arr!=null">
            AND
            <foreach collection="manager_corp_arr" index="index" item="item" open="(" separator="or" close=")">
                def_store.corp_code =#{item}
            </foreach>
        </if>
        <if test="find_type=='user'.toString()">
            AND (def_store.isopen='Y' OR def_store.close_date is NOT NULL )
            AND def_store.isactive='Y'
        </if>
        <if test="area_code != null and area_code !=''">
            AND (
            <foreach item="item" index="index" collection="area_code" open="(" separator="or" close=")">
                def_store.area_code LIKE concat('%',#{item},'%')
            </foreach>
            <if test="store_codes != null and store_codes !=''">
                OR def_store.store_code IN
                <foreach collection="store_codes" index="index" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            )
        </if>
        <if test="brand_code != null and brand_code !=''">
            AND
            <foreach item="item" index="index" collection="brand_code" open="(" separator="or" close=")">
                def_store.brand_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="city != null and city !=''">
            AND def_store.city IN
            <foreach collection="city" index="index" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="search_value != null and search_value !=''">
            and def_store.store_name like concat('%',#{search_value},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <select id="selectStore" resultType="com.bizvane.ishop.entity.Store">
        SELECT store_code,
        store_name,
        brand_code,
        logo
        FROM def_store
        WHERE 1=1
        AND corp_code=#{corp_code}
        AND store_code IN
        <foreach collection="store_codes" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        AND isactive = 'Y'
    </select>
    <!--下拉框，根据店铺编号拉店铺（店长，导购）-->
    <select id="selStoreByStoreCodes" resultMap="Store">
        select
        def_store.id,
        store_code,
        store_name,
        def_store.area_code,
        def_store.corp_code,
        def_store.logo,
        def_corp.corp_name
        from def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.store_code IN
        <foreach item="item" index="index" collection="store_codes" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND def_store.corp_code = #{corp_code}
        <if test="search_value != null and search_value !=''">
            AND def_store.store_name LIKE concat('%',#{search_value},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <select id="selStoreByVipRecord" resultMap="Store">
        select
        def_store.id,
        store_code,
        store_name,
        def_store.area_code,
        def_store.corp_code,
        def_store.logo,
        def_corp.corp_name
        from def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        <if test="corp_code != null and corp_code !=''">
            AND def_store.corp_code = #{corp_code}
        </if>
        <if test="search_value != null and search_value !=''">
            AND def_store.store_name LIKE concat('%',#{search_value},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>


    <!--列表，根据店铺编号拉店铺（店长，导购）-->
    <select id="selectByStoreCodes" resultMap="Store">
        select
        def_store.id,
        store_id,
        store_code,
        store_name,
        brand_code,
        province,
        city,
        area,
        street,
        flg_tob,
        def_store.area_code,
        def_store.corp_code,
        def_store.modified_date,
        def_store.modifier,
        def_store.isactive,
        def_store.offline_area,
        def_store.dealer,
        def_store.store_type,
        def_store.isopen,
        def_store.open_date,
        def_store.close_date,
        def_store.open_date_count,
        def_store.open_person,
        def_store.logo,
        def_corp.corp_name
        from def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.store_code IN
        <foreach item="item" index="index" collection="store_codes" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND def_store.corp_code = #{corp_code}
        <if test="search_value != null and search_value !=''">
            AND
            (store_code like concat('%',#{search_value},'%')
            OR def_store.store_id like concat('%',#{search_value},'%')
            OR store_name like concat('%',#{search_value},'%')
            OR def_corp.corp_name like concat('%',#{search_value},'%')
            )
        </if>
        <if test="isactive != null and isactive !=''">
            AND def_store.isactive = #{isactive}
        </if>
        AND def_corp.isactive = 'Y'
        ORDER BY def_store.id DESC
    </select>

    <insert id="insertStore" parameterType="com.bizvane.ishop.entity.Store">
        INSERT INTO def_store
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="store_code!=null">
                store_code,
            </if>
            <if test="store_name!=null">
                store_name,
            </if>
            <if test="brand_code!=null">
                brand_code,
            </if>
            <if test="area_code!=null">
                area_code,
            </if>
            <if test="corp_code!=null">
                corp_code,
            </if>
            <if test="flg_tob!=null">
                flg_tob,
            </if>
            <if test="province!=null">
                province,
            </if>
            <if test="city!=null">
                city,
            </if>
            <if test="area!=null">
                area,
            </if>
            <if test="street!=null">
                street,
            </if>
            <if test="modified_date!=null">
                modified_date,
            </if>
            <if test="modifier!=null">
                modifier,
            </if>
            <if test="created_date!=null">
                created_date,
            </if>
            <if test="creater!=null">
                creater,
            </if>
            <if test="isactive!=null">
                isactive,
            </if>
            <if test="offline_area!=null">
                offline_area,
            </if>
            <if test="store_id!=null">
                store_id,
            </if>
            <if test="lng!=null">
                lng,
            </if>
            <if test="lat!=null">
                lat,
            </if>
            <if test="logo!=null">
                logo,
            </if>
            <if test="dealer!=null">
                dealer,
            </if>
            <if test="store_type!=null">
                store_type,
            </if>
            <if test="isopen!=null">
                isopen,
            </if>
            <if test="open_date!=null">
                open_date,
            </if>
            <if test="close_date!=null">
                close_date,
            </if>
            <if test="open_date_count!=null">
                open_date_count,
            </if>
            <if test="open_person!=null">
                open_person,
            </if>
        </trim>
        <trim prefix="values(" suffix=")" suffixOverrides=",">
            <if test="store_code!=null">
                #{store_code},
            </if>
            <if test="store_name!=null">
                #{store_name},
            </if>
            <if test="brand_code!=null">
                #{brand_code},
            </if>
            <if test="area_code!=null">
                #{area_code},
            </if>
            <if test="corp_code!=null">
                #{corp_code},
            </if>
            <if test="flg_tob!=null">
                #{flg_tob},
            </if>
            <if test="province!=null">
                #{province},
            </if>
            <if test="city!=null">
                #{city},
            </if>
            <if test="area!=null">
                #{area},
            </if>
            <if test="street!=null">
                #{street},
            </if>
            <if test="modified_date!=null">
                #{modified_date},
            </if>
            <if test="modifier!=null">
                #{modifier},
            </if>
            <if test="created_date!=null">
                #{created_date},
            </if>
            <if test="creater!=null">
                #{creater},
            </if>
            <if test="isactive!=null">
                #{isactive},
            </if>
            <if test="offline_area!=null">
                #{offline_area},
            </if>
            <if test="store_id!=null">
                #{store_id},
            </if>
            <if test="lng!=null">
                #{lng},
            </if>
            <if test="lat!=null">
                #{lat},
            </if>
            <if test="logo!=null">
                #{logo},
            </if>
            <if test="dealer!=null">
                #{dealer},
            </if>
            <if test="store_type!=null">
                #{store_type},
            </if>
            <if test="isopen!=null">
                #{isopen},
            </if>
            <if test="open_date!=null">
                #{open_date},
            </if>
            <if test="close_date!=null">
                #{close_date},
            </if>
            <if test="open_date_count!=null">
                #{open_date_count},
            </if>
            <if test="open_person!=null">
                #{open_person},
            </if>
        </trim>
    </insert>

    <update id="updateStore" parameterType="com.bizvane.ishop.entity.Store">
        UPDATE def_store
        <trim prefix="SET" suffixOverrides=",">
            <if test="store_code!=null ">
                store_code=#{store_code},
            </if>
            <if test="store_id!=null ">
                store_id=#{store_id},
            </if>
            <if test="store_name!=null ">
                store_name=#{store_name},
            </if>
            <if test="brand_code!=null ">
                brand_code=#{brand_code},
            </if>
            <if test="area_code!=null ">
                area_code=#{area_code},
            </if>
            <if test="corp_code!=null ">
                corp_code=#{corp_code},
            </if>
            <if test="flg_tob!=null ">
                flg_tob = #{flg_tob},
            </if>
            <if test="province!=null ">
                province = #{province},
            </if>
            <if test="city!=null ">
                city = #{city},
            </if>
            <if test="area!=null ">
                area = #{area},
            </if>
            <if test="street!=null ">
                street = #{street},
            </if>
            <if test="lng!=null ">
                lng = #{lng},
            </if>
            <if test="lat!=null ">
                lat = #{lat},
            </if>
            <if test="modified_date!=null">
                modified_date=#{modified_date},
            </if>
            <if test="modifier!=null ">
                modifier=#{modifier},
            </if>
            <if test="created_date!=null">
                created_date=#{created_date},
            </if>
            <if test="creater!=null ">
                creater=#{creater},
            </if>
            <if test="isactive!=null ">
                isactive=#{isactive},
            </if>

            <if test="offline_area!=null ">
                offline_area=#{offline_area},
            </if>
            <if test="logo!=null ">
                logo=#{logo},
            </if>
            <if test="dealer!=null">
                dealer= #{dealer},
            </if>
            <if test="store_type!=null">
                store_type= #{store_type},
            </if>
            <if test="isopen!=null">
                isopen= #{isopen},
            </if>
            <!--<if test="open_date!=null">-->
            <!--open_date= #{open_date},-->
            <!--</if>-->
            <if test="close_date!=null">
                close_date= #{close_date},
            </if>
            <if test="open_date_count!=null">
                open_date_count= #{open_date_count},
            </if>
            <if test="open_person!=null">
                open_person= #{open_person},
            </if>
        </trim>
        WHERE id=#{id};
    </update>


    <update id="updateStoreByCode" parameterType="com.bizvane.ishop.entity.Store">
        UPDATE def_store
        <trim prefix="SET" suffixOverrides=",">
            <if test="store_code!=null ">
                store_code=#{store_code},
            </if>
            <if test="store_id!=null ">
                store_id=#{store_id},
            </if>
            <if test="store_name!=null ">
                store_name=#{store_name},
            </if>
            <if test="brand_code!=null ">
                brand_code=#{brand_code},
            </if>
            <if test="area_code!=null ">
                area_code=#{area_code},
            </if>
            <if test="corp_code!=null ">
                corp_code=#{corp_code},
            </if>
            <if test="flg_tob!=null ">
                flg_tob = #{flg_tob},
            </if>
            <if test="province!=null ">
                province = #{province},
            </if>
            <if test="city!=null ">
                city = #{city},
            </if>
            <if test="area!=null ">
                area = #{area},
            </if>
            <if test="street!=null ">
                street = #{street},
            </if>
            <if test="lng!=null ">
                lng = #{lng},
            </if>
            <if test="lat!=null ">
                lat = #{lat},
            </if>
            <if test="modified_date!=null">
                modified_date=#{modified_date},
            </if>
            <if test="modifier!=null ">
                modifier=#{modifier},
            </if>
            <if test="created_date!=null">
                created_date=#{created_date},
            </if>
            <if test="creater!=null ">
                creater=#{creater},
            </if>
            <if test="isactive!=null ">
                isactive=#{isactive},
            </if>

            <if test="offline_area!=null ">
                offline_area=#{offline_area},
            </if>
            <if test="logo!=null ">
                logo=#{logo},
            </if>
            <if test="dealer!=null">
                dealer= #{dealer},
            </if>
            <if test="store_type!=null">
                store_type= #{store_type},
            </if>
            <if test="isopen!=null">
                isopen= #{isopen},
            </if>
            <!--<if test="open_date!=null">-->
            <!--open_date= #{open_date},-->
            <!--</if>-->
            <if test="close_date!=null">
                close_date= #{close_date},
            </if>
            <if test="open_date_count!=null">
                open_date_count= #{open_date_count},
            </if>
            <if test="open_person!=null">
                open_person= #{open_person},
            </if>
        </trim>
        WHERE corp_code =#{corp_code} AND store_code =#{store_code} AND isactive ='Y';
    </update>


    <delete id="deleteByStoreId">
        DELETE FROM
        def_store
        WHERE ID=#{id}
    </delete>

    <!--删除店铺下员工-->
    <update id="deleteStoreUser">
        UPDATE def_user
        SET store_code=replace(store_code,#{store_code},'')
        WHERE id=#{user_id}
    </update>

    <!--判断店铺名称是否重复-->
    <select id="selectByStoreName" resultType="com.bizvane.ishop.entity.Store">
        SELECT * FROM def_store
        WHERE corp_code=#{corp_code}
        AND store_name=#{store_name}
        <if test="isactive != null and isactive !=''">
            AND isactive = #{isactive}
        </if>
    </select>

    <!--店铺数量  / 店铺新增数量-->
    <select id="selectCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM def_store
        WHERE 1=1
        <if test="created_date !=''">
            AND created_date LIKE concat(#{created_date},'%')
        </if>
    </select>

    <select id="selectAchCount" resultType="java.lang.Integer">
        SELECT count(1) FROM def_store_ACHV_GOAL
        WHERE store_code=#{store_code}
        AND corp_code = #{corp_code}
    </select>

    <select id="selectAllStoreScreen" resultMap="Store">
        SELECT
        ds.id,
        store_id,
        store_code,
        store_name,
        flg_tob,
        province,
        city,
        area,
        street,
        ds.area_code,
        ds.brand_code,
        ds.corp_code,
        ds.modified_date,
        ds.modifier,
        ds.isactive,
        ds.offline_area,
        ds.dealer,
        ds.store_type,
        ds.isopen,
        ds.open_date,
        ds.close_date,
        ds.open_date_count,
        ds.open_person,
        ds.logo,
        dc.corp_name
        FROM def_store ds,def_corp dc,def_area da,def_brand db
        WHERE ds.corp_code = dc.corp_code
        AND ds.corp_code = da.corp_code
        AND ds.corp_code = db.corp_code
        <if test="corp_code!=null and corp_code!=''">
            AND ds.corp_code=#{corp_code}
        </if>
        <if test="manager_corp_arr!=null">
            AND
            <foreach collection="manager_corp_arr" index="index" item="item" open="(" separator="or" close=")">
                ds.corp_code =#{item}
            </foreach>
        </if>
        <if test="find_type=='user'.toString()">
            AND (ds.isopen='Y' OR ds.close_date is NOT NULL )
            AND ds.isactive='Y'
        </if>
        <if test="area_codes!=null and area_codes!=''">
            AND (
            <foreach collection="area_codes" index="index" item="item" open="(" separator="or" close=")">
                ds.area_code LIKE concat('%',#{item},'%')
            </foreach>
            <if test="area_store_codes != null and area_store_codes !=''">
                OR ds.store_code IN
                <foreach collection="area_store_codes" index="index" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            )
        </if>
        <if test="brand_codes != null and brand_codes!=''">
            AND
            <foreach collection="brand_codes" item="item" index="index" open="(" separator="or" close=")">
                ds.brand_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="store_codes!=null and store_codes!=''">
            AND ds.store_code IN
            <foreach collection="store_codes" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="map!=null">
            AND
            <foreach collection="map" index="entryKey" item="entryValue" open="(" separator="and" close=")">
                <choose>
                    <when test="entryValue!='' and entryKey=='corp_name'">
                        dc.${entryKey} REGEXP ${entryValue}
                    </when>
                    <when test="entryValue!='' and entryKey=='area_name'">
                        ds.area_code LIKE concat('%§',da.area_code,',%')
                        AND da.${entryKey} REGEXP ${entryValue}
                    </when>
                    <when test="entryValue!='' and entryKey=='brand_name'">
                        ds.brand_code LIKE concat('%§',db.brand_code,',%')
                        AND db.${entryKey} REGEXP ${entryValue}
                    </when>
                    <when test="entryValue!=''">
                        ds.${entryKey} REGEXP ${entryValue}
                    </when>
                    <otherwise>
                        1=1
                    </otherwise>
                </choose>
            </foreach>
        </if>
        <if test="isactive != null and isactive!=''">
            AND ds.isactive = #{isactive}
        </if>
        AND dc.isactive = 'Y'
        AND da.isactive = 'Y'
        AND db.isactive = 'Y'
        GROUP BY ds.id
        ORDER BY ds.id DESC
    </select>

    <select id="selectAllStoreScreenEasy" resultMap="Store">
        SELECT
        ds.id,
        store_id,
        store_code,
        store_name,
        flg_tob,
        province,
        city,
        area,
        street,
        ds.area_code,
        ds.brand_code,
        ds.corp_code,
        ds.modified_date,
        ds.modifier,
        ds.isactive,
        ds.offline_area,
        ds.dealer,
        ds.store_type,
        ds.isopen,
        ds.open_date,
        ds.close_date,
        ds.open_date_count,
        ds.open_person,
        ds.logo,
        dc.corp_name
        FROM def_store ds,def_corp dc
        WHERE ds.corp_code = dc.corp_code
        <if test="corp_code!=null and corp_code!=''">
            AND ds.corp_code=#{corp_code}
        </if>
        <if test="manager_corp_arr!=null">
            AND
            <foreach collection="manager_corp_arr" index="index" item="item" open="(" separator="or" close=")">
                ds.corp_code =#{item}
            </foreach>
        </if>
        <if test="find_type=='user'.toString()">
            AND (ds.isopen='Y' OR ds.close_date is NOT NULL )
            AND ds.isactive='Y'
        </if>
        <if test="area_codes!=null and area_codes!=''">
            AND (
            <foreach collection="area_codes" index="index" item="item" open="(" separator="or" close=")">
                ds.area_code LIKE concat('%',#{item},'%')
            </foreach>
            <if test="area_store_codes != null and area_store_codes !=''">
                OR ds.store_code IN
                <foreach collection="area_store_codes" index="index" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            )
        </if>
        <if test="brand_codes != null and brand_codes!=''">
            AND
            <foreach collection="brand_codes" item="item" index="index" open="(" separator="or" close=")">
                ds.brand_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="store_codes!=null and store_codes!=''">
            AND ds.store_code IN
            <foreach collection="store_codes" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="map!=null">
            AND
            <foreach collection="map" index="entryKey" item="entryValue" open="(" separator="and" close=")">
                <choose>
                    <when test="entryValue!='' and entryKey=='corp_name'">
                        dc.${entryKey} REGEXP ${entryValue}
                    </when>
                    <when test="entryValue!=''">
                        ds.${entryKey} REGEXP ${entryValue}
                    </when>
                    <otherwise>
                        1=1
                    </otherwise>
                </choose>
            </foreach>
        </if>
        <if test="isactive != null and isactive!=''">
            AND ds.isactive = #{isactive}
        </if>
        AND dc.isactive = 'Y'
        GROUP BY ds.id
        ORDER BY ds.id DESC
    </select>

    <select id="selectStoreCountByArea" resultType="com.bizvane.ishop.entity.Store">
        SELECT
        ds.id,
        store_code,
        store_name,
        ds.area_code,
        ds.corp_code,
        ds.logo
        FROM def_store ds,def_corp dc
        WHERE ds.corp_code = dc.corp_code
        AND ds.corp_code = #{corp_code}
        AND
        <foreach collection="array" index="index" item="item" open="(" separator="or" close=")">
            ds.area_code LIKE concat('%',#{item},'%')
        </foreach>
        <if test="isactive != null and isactive !=''">
            AND ds.isactive = #{isactive}
        </if>
        AND dc.isactive = 'Y'
        ORDER BY ds.id DESC
    </select>

    <select id="selectStoreCountByBrand" resultType="com.bizvane.ishop.entity.Store">
        SELECT ds.id,
        ds.store_code,
        ds.store_name,
        ds.logo
        FROM def_store ds,def_corp dc
        WHERE ds.corp_code = dc.corp_code
        AND ds.corp_code=#{corp_code}
        AND
        <foreach collection="array" index="index" item="item" open="(" separator="or" close=")">
            ds.brand_code LIKE concat('%',#{item},'%')
        </foreach>
        <if test="search_value != null and search_value !=''">
            AND ds.store_name LIKE concat('%',#{search_value},'%')
        </if>
        <if test="isactive != null and isactive !=''">
            AND ds.isactive = #{isactive}
        </if>
        AND dc.isactive = 'Y'
        GROUP BY ds.id
        ORDER BY ds.id DESC
    </select>

    <select id="selectStoreCity" resultType="com.bizvane.ishop.entity.Store">
        SELECT city,logo
        FROM def_store
        WHERE isactive= 'Y'
        AND corp_code = #{corp_code}
        AND city IS NOT NULL
        AND city != ""
        <if test="search_value != null and search_value !=''">
            AND def_store.city LIKE concat('%',#{search_value},'%')
        </if>
        GROUP BY city
        ORDER BY city;
    </select>

    <select id="selectAllOrderByCity" resultMap="Store">
        SELECT
        def_store.id,
        store_code,
        store_name,
        province,
        city,
        area,
        street,
        def_store.area_code,
        def_store.brand_code,
        def_store.corp_code,
        def_store.lng,
        def_store.lat,
        def_store.logo
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        <if test="corp_code != null and corp_code !=''">
            AND def_store.corp_code = #{corp_code}
        </if>
        <if test="search_value != null and search_value !=''">
            AND
            (province LIKE concat('%',#{search_value},'%')
            OR city LIKE concat('%',#{search_value},'%')
            OR area LIKE concat('%',#{search_value},'%')
            OR street LIKE concat('%',#{search_value},'%')
            OR concat(province,city,area,street) LIKE concat('%',#{search_value},'%')
            OR store_name LIKE concat('%',#{search_value},'%')
            )
        </if>
        AND def_store.isactive = 'Y'
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
        ORDER BY def_store.province DESC, def_store.city DESC
    </select>

    <select id="selectNearByStore" resultMap="Store">
        SELECT
        def_store.id,
        store_code,
        store_name,
        province,
        city,
        area,
        street,
        def_store.area_code,
        def_store.brand_code,
        def_store.corp_code,
        def_store.lng,
        def_store.lat,
        def_store.logo,
        ROUND(6378.138*2*ASIN(SQRT(POW(SIN((#{lat}*PI()/180-lat*PI()/180)/2),2)+COS(#{lat}*PI()/180)*COS(lat*PI()/180)*POW(SIN((#{lng}*PI()/180-lng*PI()/180)/2),2)))*1000)  AS distance
        FROM def_store,def_corp
        WHERE def_store.corp_code = def_corp.corp_code
        AND def_store.corp_code = #{corp_code}
        AND def_store.lng IS NOT NULL AND def_store.lng != ''
        AND def_store.lat IS NOT NULL AND def_store.lat != ''
        AND def_store.isactive = 'Y'
        AND def_corp.isactive = 'Y'
        GROUP BY def_store.id
            HAVING distance &lt; #{distance}
        ORDER BY distance
    </select>
    <select id="getStoreByOdsType" resultType="com.bizvane.ishop.entity.Store">
        SELECT ${line_code} FROM def_store WHERE 1=1
        AND corp_code=#{corp_code}
        AND isactive ='Y'
        GROUP BY ${line_code}
        HAVING ${line_code} !='' AND ${line_code} IS NOT NULL
    </select>

    <select id="getAllStoreByCount" resultMap="Store">
        SELECT
        def_store.id,
        def_store.store_code,
        def_store.corp_code,
        def_store.store_name,
        def_store.isopen,
        def_store.open_date,
        def_store.close_date,
        def_store.open_person,
        def_store.open_date_count
        FROM def_store,def_corp
        WHERE def_store.corp_code=def_corp.corp_code
        AND def_store.isopen='Y'
        AND def_store.isactive='Y'
        AND def_corp.isactive='Y'
        GROUP BY def_store.id
        ORDER BY def_store.id DESC
    </select>

    <update id="updStoreDayCount">
       UPDATE `def_store` SET open_date_count= IFNULL(open_date_count,0)+1 WHERE isopen='Y' AND isactive='Y'
    </update>
    
    <update id="updStoreTime">
        update `def_store` set `OPEN_DATE` =DATE_ADD((SELECT `CREATED_DATE` from `def_corp` WHERE `CORP_CODE` =#{corp_code}), INTERVAL 1 MONTH)
        where `CREATED_DATE` IS NULL or `CREATED_DATE` ='' AND corp_code=#{corp_code}
    </update>

    <select id="selectByStoreNameTwo" resultType="com.bizvane.ishop.entity.Store">
        SELECT * FROM def_store
        WHERE corp_code=#{corp_code}
        AND store_name LIKE concat('%',#{store_name},'%')
        <if test="isactive != null and isactive !=''">
            AND isactive = #{isactive}
        </if>
    </select>

    <select id="getStoreAndBrandArea" resultMap="Store">
        SELECT *
        FROM def_store ds
        WHERE ds.corp_code=#{corp_code}
        AND (
        <if test="area_codes != null ">
            <foreach collection="area_codes" index="index" item="item" open="(" separator="or" close=")">
                ds.area_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="brand_codes != null">
          <if test="area_codes!=null"> AND </if>
            <foreach collection="brand_codes" item="item" index="index" open="(" separator="or" close=")">
                ds.brand_code LIKE concat('%',#{item},'%')
            </foreach>
        </if>
        <if test="store_codes!=null">
            <if test="area_codes != null or brand_codes != null"> OR </if>
             ds.store_code IN
            <foreach collection="store_codes" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )
        AND ds.isactive = 'Y'
        GROUP BY ds.id
        ORDER BY ds.id DESC
    </select>


    <select id="selectCorpCanSearch" resultType="com.bizvane.ishop.entity.Store">
        select *
        FROM def_store
        WHERE corp_code = #{corp_code}
        AND isactive = 'Y'
        <if test="search_value != null and search_value !=''">
            AND
            (store_code LIKE concat('%',#{search_value},'%')
            OR store_name LIKE concat('%',#{search_value},'%')
            )
        </if>
        ORDER BY def_store.id DESC
    </select>

    <select id="selctStoreQrcode" resultType="com.bizvane.ishop.entity.StoreQrcode">
        SELECT
        ruq.*,
        rcw.app_name
        FROM rel_store_qrcode ruq ,rel_corp_wechat rcw
        WHERE  ruq.corp_code = rcw.corp_code
        and ruq.app_id = rcw.app_id
        AND ruq.store_code=#{store_code}
        AND ruq.corp_code=#{corp_code}
        AND rcw.app_id=#{app_id}
        AND rcw.isactive = 'Y'
        AND rcw.is_authorize = 'Y'
    </select>


</mapper>
